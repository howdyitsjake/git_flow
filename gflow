#!/bin/bash

# Universal Git Flow Controller
# Works in any Git repository!

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

show_help() {
    echo -e "${CYAN}=========================================="
    echo "   Universal Git Flow"
    echo -e "==========================================${NC}"
    echo ""
    echo "Usage: gflow [option]"
    echo ""
    echo "Options:"
    echo "  -b, --branch     Create a new feature branch"
    echo "  -s, --sync       Save and push your changes"
    echo "  -m, --merge      Merge branch to main"
    echo "  -h, --help       Show this help message"
    echo ""
    echo "Examples:"
    echo "  gflow -b    # Start new feature"
    echo "  gflow -s    # Save progress"
    echo "  gflow -m    # Complete feature"
    echo ""
    
    # Check if in a git repo
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Not in a Git repository${NC}"
        echo ""
        echo "To use gflow, navigate to a Git repo:"
        echo "  cd /path/to/your/project"
        echo "  gflow -b"
        exit 1
    fi
    
    echo "Current Status:"
    echo "----------------------------------------"
    CURRENT_BRANCH=$(git branch --show-current 2>/dev/null)
    REPO_NAME=$(basename $(git rev-parse --show-toplevel))
    echo "Repository: $REPO_NAME"
    echo "Branch: $CURRENT_BRANCH"
    CHANGED_FILES=$(git status --short | wc -l | tr -d ' ')
    echo "Changed files: $CHANGED_FILES"
    echo ""
    if [ -n "$(git status --porcelain)" ]; then
        echo -e "${YELLOW}üí° You have uncommitted changes${NC}"
        echo "   Run: gflow -s"
    fi
    echo "=========================================="
}

create_branch() {
    # Check if in git repo
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Not in a Git repository${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}=========================================="
    echo "   Create New Feature Branch"
    echo -e "==========================================${NC}"
    echo ""

    CURRENT_BRANCH=$(git branch --show-current)
    REPO_NAME=$(basename $(git rev-parse --show-toplevel))
    echo "Repository: $REPO_NAME"
    echo "Current branch: $CURRENT_BRANCH"
    echo ""

    # Check for uncommitted changes first
    if [ -n "$(git status --porcelain)" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  You have uncommitted changes!${NC}"
        echo ""
        git status --short | head -10
        echo ""
        echo "You must save or discard changes before creating a branch."
        read -p "Save changes now? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            read -p "Commit message: " TEMP_MESSAGE
            if [ -z "$TEMP_MESSAGE" ]; then
                TEMP_MESSAGE="WIP: Save before branching"
            fi
            git add .
            git commit -m "$TEMP_MESSAGE" --quiet
            git push origin "$CURRENT_BRANCH" --quiet 2>/dev/null
            echo -e "${GREEN}‚úÖ Changes saved${NC}"
        else
            echo ""
            echo -e "${RED}‚ùå Cannot create branch with uncommitted changes${NC}"
            echo "Either:"
            echo "  1. Run: gflow -s (to save changes)"
            echo "  2. Run: git stash (to temporarily hide changes)"
            echo "  3. Run: git reset --hard (to discard changes)"
            exit 1
        fi
    fi

    # Always switch to main and pull latest
    echo ""
    echo "Switching to main branch..."
    git checkout main --quiet
    echo -e "${GREEN}‚úÖ On main branch${NC}"
    
    echo ""
    echo "Pulling latest changes from GitHub..."
    git pull origin main --quiet 2>/dev/null
    
    # Check if pull was successful
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ Main branch updated with latest changes${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Could not pull from remote (may be first push)${NC}"
    fi

    echo ""
    echo "Branch Name Examples:"
    echo "  - add-search-filters"
    echo "  - fix-video-bug"
    echo "  - improve-ui-speed"
    echo ""
    read -p "Enter branch name: " BRANCH_NAME

    if [ -z "$BRANCH_NAME" ]; then
        echo -e "${RED}‚ùå Branch name cannot be empty${NC}"
        exit 1
    fi

    # Add prefix if not present
    if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|enhancement|hotfix)/ ]]; then
        echo ""
        echo "Choose prefix:"
        echo "  1) feature/    (new functionality)"
        echo "  2) bugfix/     (fix an error)"
        echo "  3) enhancement/ (improve existing)"
        echo "  4) hotfix/     (urgent fix)"
        echo "  5) none        (use as-is)"
        read -p "Choose (1-5): " PREFIX_CHOICE
        
        case $PREFIX_CHOICE in
            1) BRANCH_NAME="feature/$BRANCH_NAME" ;;
            2) BRANCH_NAME="bugfix/$BRANCH_NAME" ;;
            3) BRANCH_NAME="enhancement/$BRANCH_NAME" ;;
            4) BRANCH_NAME="hotfix/$BRANCH_NAME" ;;
        esac
    fi

    echo ""
    echo "Creating: $BRANCH_NAME"
    git checkout -b "$BRANCH_NAME"
    git push -u origin "$BRANCH_NAME" --quiet 2>/dev/null

    echo ""
    echo -e "${GREEN}=========================================="
    echo "‚úÖ Branch Created!"
    echo -e "==========================================${NC}"
    echo ""
    echo "Repository: $REPO_NAME"
    echo "Branch: $BRANCH_NAME"
    echo ""
    echo "Next: Make changes, then run:"
    echo "  gflow -s"
}

sync_changes() {
    # Check if in git repo
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Not in a Git repository${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}=========================================="
    echo "   Sync Changes"
    echo -e "==========================================${NC}"
    echo ""

    CURRENT_BRANCH=$(git branch --show-current)
    REPO_NAME=$(basename $(git rev-parse --show-toplevel))
    echo "Repository: $REPO_NAME"
    echo "Branch: $CURRENT_BRANCH"

    # Warn if on main
    if [ "$CURRENT_BRANCH" = "main" ]; then
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  You're on main branch${NC}"
        echo "Consider using a feature branch instead"
        read -p "Continue anyway? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    echo ""
    echo "Changes:"
    git status --short

    CHANGED_FILES=$(git status --short | wc -l | tr -d ' ')
    echo ""
    echo "Files: $CHANGED_FILES"

    if [ -z "$(git status --porcelain)" ]; then
        echo -e "${GREEN}‚úÖ No changes to sync${NC}"
        exit 0
    fi

    echo ""
    read -p "Sync these changes? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 0
    fi

    echo ""
    echo "Describe your changes:"
    echo "(e.g., 'Add search filter', 'Fix video bug')"
    echo ""
    read -p "Message: " COMMIT_MESSAGE

    if [ -z "$COMMIT_MESSAGE" ]; then
        COMMIT_MESSAGE="Update on $CURRENT_BRANCH"
    fi

    echo ""
    echo "Saving..."
    git add .
    git commit -m "$COMMIT_MESSAGE" --quiet
    git push origin "$CURRENT_BRANCH" --quiet

    echo ""
    echo -e "${GREEN}=========================================="
    echo "‚úÖ Sync Complete!"
    echo -e "==========================================${NC}"
    echo ""
    echo "Repository: $REPO_NAME"
    echo "Branch: $CURRENT_BRANCH"
    echo "Commit: $COMMIT_MESSAGE"
    echo ""
    echo "Changes backed up on GitHub"
    echo ""
    if [ "$CURRENT_BRANCH" != "main" ]; then
        echo "When done, run: gflow -m"
    fi
}

merge_branch() {
    # Check if in git repo
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Not in a Git repository${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}=========================================="
    echo "   Merge to Main"
    echo -e "==========================================${NC}"
    echo ""

    CURRENT_BRANCH=$(git branch --show-current)
    REPO_NAME=$(basename $(git rev-parse --show-toplevel))

    if [ "$CURRENT_BRANCH" = "main" ]; then
        echo -e "${RED}‚ùå Already on main branch${NC}"
        echo "Switch to a feature branch first"
        exit 1
    fi

    echo "Repository: $REPO_NAME"
    echo "Merge: $CURRENT_BRANCH ‚Üí main"

    # Check for uncommitted changes
    if [ -n "$(git status --porcelain)" ]; then
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  Uncommitted changes detected${NC}"
        git status --short
        echo ""
        read -p "Sync first? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sync_changes
        else
            echo -e "${RED}‚ùå Commit changes before merging${NC}"
            exit 1
        fi
    fi

    echo ""
    echo "Summary:"
    echo "----------------------------------------"
    echo "Commits:"
    git log main..$CURRENT_BRANCH --oneline --no-decorate 2>/dev/null | head -10
    echo ""
    echo "Files changed:"
    git diff --name-status main..$CURRENT_BRANCH 2>/dev/null | head -15
    TOTAL_FILES=$(git diff --name-status main..$CURRENT_BRANCH 2>/dev/null | wc -l | tr -d ' ')
    echo ""
    echo "Total: $TOTAL_FILES files"

    echo ""
    echo -e "${YELLOW}=========================================="
    echo "‚ö†Ô∏è  MERGE CONFIRMATION"
    echo -e "==========================================${NC}"
    echo ""
    echo "Repository: $REPO_NAME"
    echo "This will merge '$CURRENT_BRANCH' into main"
    echo ""
    read -p "Type 'yes' to proceed: " CONFIRM

    if [ "$CONFIRM" != "yes" ]; then
        echo "Cancelled"
        exit 0
    fi

    echo ""
    echo "Merging..."
    git checkout main --quiet
    git pull origin main --quiet 2>/dev/null
    
    git merge --no-ff "$CURRENT_BRANCH" -m "Merge '$CURRENT_BRANCH' into main" --quiet
    
    if [ $? -ne 0 ]; then
        echo ""
        echo -e "${RED}=========================================="
        echo "‚ùå MERGE CONFLICT"
        echo -e "==========================================${NC}"
        echo ""
        echo "Conflicting files:"
        git diff --name-only --diff-filter=U
        echo ""
        echo "To resolve:"
        echo "  1. Open conflicting files"
        echo "  2. Fix conflicts (look for <<<<<<)"
        echo "  3. git add <file>"
        echo "  4. git commit"
        echo "  5. git push origin main"
        echo ""
        echo "Or cancel: git merge --abort"
        exit 1
    fi

    git push origin main --quiet

    echo ""
    echo -e "${GREEN}=========================================="
    echo "‚úÖ Merge Complete!"
    echo -e "==========================================${NC}"
    echo ""

    read -p "Delete branch '$CURRENT_BRANCH'? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git branch -d "$CURRENT_BRANCH" 2>/dev/null
        git push origin --delete "$CURRENT_BRANCH" 2>/dev/null
        echo -e "${GREEN}‚úÖ Branch deleted${NC}"
    fi

    echo ""
    echo "On main branch in $REPO_NAME"
}

# Main logic
case "$1" in
    -b|--branch)
        create_branch
        ;;
    -s|--sync)
        sync_changes
        ;;
    -m|--merge)
        merge_branch
        ;;
    -h|--help|"")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown option: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
